name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: buildozer-apk-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-apk-${{ runner.os }}-

      - name: Clean corrupted p4a cache
        run: |
          rm -rf .buildozer/android/platform/python-for-android
          rm -rf ~/.buildozer/android/platform/python-for-android

      - name: Build APK
        run: |
          docker run --rm \
            -e BUILDOZER_WARN_ON_ROOT=0 \
            -v "${{ github.workspace }}:/app:Z" \
            -v "$HOME/.buildozer:/home/user/.buildozer:Z" \
            -w /app \
            kivy/buildozer:latest \
            android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apno-android-apk
          path: bin/*.apk
          retention-days: 30

  build-aab:
    name: Build Android AAB
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: buildozer-aab-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-aab-${{ runner.os }}-

      - name: Clean corrupted p4a cache
        run: |
          rm -rf .buildozer/android/platform/python-for-android
          rm -rf ~/.buildozer/android/platform/python-for-android

      - name: Build AAB
        run: |
          docker run --rm \
            -e BUILDOZER_WARN_ON_ROOT=0 \
            -v "${{ github.workspace }}:/app:Z" \
            -v "$HOME/.buildozer:/home/user/.buildozer:Z" \
            -w /app \
            kivy/buildozer:latest \
            android release

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: apno-android-aab
          path: bin/*.aab
          retention-days: 30
